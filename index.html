<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ベラ会計</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
        }
        .preset-button {
            transition: all 0.2s ease;
        }
        .preset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-input, .form-select, .form-textarea {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .table-row-selected {
            background-color: #e0f2fe;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- メッセージボックス -->
    <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white font-bold hidden transition-opacity duration-300 z-50"></div>

    <div class="container mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-700">ベラ会計</h1>
            <p class="mt-2 text-lg text-gray-600">簡単入力、多様な集計、共有可能な会計システム</p>
        </header>

        <!-- 集計サマリー -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">年度別集計</h2>
            <div id="summary-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="bg-green-50 p-4 rounded-xl shadow-inner flex flex-col items-center">
                    <p class="text-sm font-semibold text-green-700">収入</p>
                    <p id="total-income" class="text-2xl font-bold mt-1 text-green-600">0円</p>
                </div>
                <div class="bg-red-50 p-4 rounded-xl shadow-inner flex flex-col items-center">
                    <p class="text-sm font-semibold text-red-700">支出</p>
                    <p id="total-expense" class="text-2xl font-bold mt-1 text-red-600">0円</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl shadow-inner flex flex-col items-center">
                    <p class="text-sm font-semibold text-blue-700">残高</p>
                    <p id="balance" class="text-2xl font-bold mt-1 text-blue-600">0円</p>
                </div>
            </div>
        </div>

        <!-- 入力フォーム -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">新規入力 / 編集</h2>
            <form id="entry-form" class="space-y-4">
                <input type="hidden" id="entry-row-index">
                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                    <div class="flex-1">
                        <label for="entry-date" class="block text-sm font-medium text-gray-700">日付</label>
                        <input type="date" id="entry-date" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div class="flex-1">
                        <label for="entry-amount" class="block text-sm font-medium text-gray-700">金額</label>
                        <input type="number" id="entry-amount" placeholder="金額" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                </div>

                <div>
                    <label for="entry-item" class="block text-sm font-medium text-gray-700">項目</label>
                    <div id="item-presets" class="flex flex-wrap gap-2 mt-2">
                        <!-- プリセットボタンはJSで生成 -->
                    </div>
                    <input type="text" id="entry-item" placeholder="項目" class="form-input mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">収支区分</label>
                    <div class="mt-2 flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="entry-type" value="収入" class="form-radio text-green-600 focus:ring-green-500">
                            <span class="ml-2">収入</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="entry-type" value="支出" class="form-radio text-red-600 focus:ring-red-500">
                            <span class="ml-2">支出</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label for="entry-memo" class="block text-sm font-medium text-gray-700">メモ</label>
                    <textarea id="entry-memo" rows="2" class="form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2" placeholder="メモ"></textarea>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 pt-4">
                    <button type="button" id="clear-button" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md shadow hover:bg-gray-300 transition-colors duration-200">入力クリア</button>
                    <button type="submit" id="submit-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow hover:bg-indigo-700 transition-colors duration-200">登録</button>
                    <button type="button" id="update-button" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-md shadow hover:bg-yellow-600 transition-colors duration-200 hidden">更新</button>
                </div>
            </form>
        </div>

        <!-- 記録と集計 -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 sm:mb-0">過去の記録</h2>
                <div class="flex space-x-2">
                    <input type="text" id="search-input" placeholder="キーワードで検索" class="form-input rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 w-full sm:w-auto">
                    <button type="button" id="bulk-delete-button" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow hover:bg-red-600 transition-colors duration-200 hidden">選択項目を削除</button>
                    <button type="button" id="bulk-summary-button" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow hover:bg-blue-600 transition-colors duration-200 hidden">選択項目を集計</button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="records-table" class="min-w-full divide-y divide-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                <input type="checkbox" id="select-all-checkbox" class="form-checkbox h-4 w-4 text-indigo-600">
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日付</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">項目</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金額</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">収支区分</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">メモ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">操作</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- 記録はここに表示されます -->
                    </tbody>
                </table>
            </div>
            
            <!-- 選択項目の集計結果表示エリア -->
            <div id="bulk-summary-results" class="mt-4 p-4 bg-gray-100 rounded-lg shadow-inner hidden">
                <h3 class="text-lg font-bold text-gray-800">選択項目の集計結果</h3>
                <p id="bulk-income" class="mt-2 text-sm">収入合計: 0円</p>
                <p id="bulk-expense" class="text-sm">支出合計: 0円</p>
                <p id="bulk-balance" class="text-sm">残高: 0円</p>
            </div>
        </div>
    </div>

    <script>
        // Google Apps ScriptのWebアプリURLに置き換えてください
        const SPREADSHEET_APP_URL = 'https://script.google.com/macros/s/AKfycbxq7ilOU6ZvGAHG1XkfrWNAggREXycWFb_mjtORT6hrtkXNggZnG_ojhlUwUoOu4jyz/exec';

        // 収支区分のプリセット
        const PRESETS = {
            income: [
                '宿泊費徴収', '生活費徴収', '飯の場', '師範部屋より徴収/補助', 
                '日比谷高校払い', '星陵会補助費', '一水会会計補助費'
            ],
            expense: [
                '施設費', '印刷など', '生活費', '飯の場', 
                '保険料', '新人/現役支援'
            ]
        };

        // UIエレメントの取得
        const form = document.getElementById('entry-form');
        const entryDateInput = document.getElementById('entry-date');
        const entryItemInput = document.getElementById('entry-item');
        const entryAmountInput = document.getElementById('entry-amount');
        const entryMemoInput = document.getElementById('entry-memo');
        const entryTypeRadios = document.querySelectorAll('input[name="entry-type"]');
        const itemPresetsContainer = document.getElementById('item-presets');
        const submitButton = document.getElementById('submit-button');
        const updateButton = document.getElementById('update-button');
        const clearButton = document.getElementById('clear-button');
        const recordsTableBody = document.getElementById('records-table-body');
        const searchInput = document.getElementById('search-input');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const bulkDeleteButton = document.getElementById('bulk-delete-button');
        const bulkSummaryButton = document.getElementById('bulk-summary-button');
        const bulkSummaryResults = document.getElementById('bulk-summary-results');

        // データと状態
        let allRecords = [];
        let filteredRecords = [];
        let selectedRecords = new Set();
        let isUpdating = false;

        // メッセージ表示関数
        function showMessage(text, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white font-bold transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} block`;
            setTimeout(() => {
                messageBox.classList.remove('block');
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // 和暦の取得
        function getJapaneseEra(year) {
            if (year >= 2019) {
                return `R${year - 2018}`; // 令和
            } else if (year >= 1989) {
                return `H${year - 1988}`; // 平成
            } else if (year >= 1926) {
                return `S${year - 1925}`; // 昭和
            }
            return year;
        }

        // 年度を取得する関数（開始月を指定）
        function getFiscalYear(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // getMonth()は0-11
            const fiscalStartMonth = 10; // 10月始まり
            const fiscalYear = month >= fiscalStartMonth ? year : year - 1;
            return {
                western: fiscalYear,
                japanese: getJapaneseEra(fiscalYear)
            };
        }

        // プリセットボタンの生成
        function renderPresets(type) {
            itemPresetsContainer.innerHTML = '';
            const presets = PRESETS[type] || [];
            presets.forEach(item => {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = item;
                button.className = 'preset-button bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded-full hover:bg-gray-300';
                button.onclick = () => entryItemInput.value = item;
                itemPresetsContainer.appendChild(button);
            });
        }

        // 収支区分ラジオボタンの変更イベント
        entryTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                renderPresets(e.target.value === '収入' ? 'income' : 'expense');
            });
        });

        // データの読み込み
        async function fetchRecords() {
            try {
                const response = await fetch(SPREADSHEET_APP_URL);
                if (!response.ok) {
                    throw new Error('データの取得に失敗しました');
                }
                const data = await response.json();
                allRecords = data.records || [];
                filterRecords();
                updateSummary();
            } catch (error) {
                console.error('Error fetching data:', error);
                showMessage('データの読み込み中にエラーが発生しました。', true);
            }
        }

        // 記録をテーブルにレンダリング
        function renderRecords(records) {
            recordsTableBody.innerHTML = '';
            records.forEach(record => {
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 transition-colors duration-150 cursor-pointer ${selectedRecords.has(record.rowIndex) ? 'table-row-selected' : ''}`;
                row.dataset.rowIndex = record.rowIndex;

                const amountText = record.amount ? `¥${record.amount.toLocaleString()}` : '';
                const typeClass = record.type === '収入' ? 'text-green-600' : 'text-red-600';

                row.innerHTML = `
                    <td class="px-2 py-4 whitespace-nowrap">
                        <input type="checkbox" data-row-index="${record.rowIndex}" class="record-checkbox form-checkbox h-4 w-4 text-indigo-600">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.item}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${typeClass}">${amountText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.memo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2 load-button" data-row-index="${record.rowIndex}">呼出</button>
                    </td>
                `;
                recordsTableBody.appendChild(row);
            });
            setupRecordEvents();
            updateBulkButtonsVisibility();
        }

        // フィルタリング機能
        function filterRecords() {
            const query = searchInput.value.toLowerCase();
            filteredRecords = allRecords.filter(record => 
                record.item.toLowerCase().includes(query) ||
                record.memo.toLowerCase().includes(query) ||
                record.date.includes(query)
            );
            renderRecords(filteredRecords);
        }

        // 検索入力のイベントリスナー
        searchInput.addEventListener('input', filterRecords);

        // テーブル行とボタンのイベントリスナー設定
        function setupRecordEvents() {
            recordsTableBody.querySelectorAll('.load-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rowIndex = parseInt(e.target.dataset.rowIndex);
                    const record = allRecords.find(r => r.rowIndex === rowIndex);
                    if (record) {
                        loadRecordToForm(record);
                    }
                });
            });

            recordsTableBody.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const rowIndex = parseInt(e.target.dataset.rowIndex);
                    if (e.target.checked) {
                        selectedRecords.add(rowIndex);
                    } else {
                        selectedRecords.delete(rowIndex);
                    }
                    updateBulkButtonsVisibility();
                    updateTableRowsSelection();
                });
            });
        }

        // フォームに記録をロードする
        function loadRecordToForm(record) {
            entryDateInput.value = record.date;
            entryItemInput.value = record.item;
            entryAmountInput.value = record.amount;
            entryMemoInput.value = record.memo;
            document.querySelector(`input[name="entry-type"][value="${record.type}"]`).checked = true;
            document.getElementById('entry-row-index').value = record.rowIndex;

            renderPresets(record.type === '収入' ? 'income' : 'expense');
            submitButton.classList.add('hidden');
            updateButton.classList.remove('hidden');
            isUpdating = true;
        }

        // フォームのリセット
        function clearForm() {
            form.reset();
            document.getElementById('entry-row-index').value = '';
            submitButton.classList.remove('hidden');
            updateButton.classList.add('hidden');
            isUpdating = false;
            // プリセットもリセット
            renderPresets('expense');
            document.querySelector('input[name="entry-type"][value="支出"]').checked = true;
        }
        clearButton.addEventListener('click', clearForm);

        // 登録・更新処理
        async function submitForm(e) {
            e.preventDefault();
            const date = entryDateInput.value;
            const item = entryItemInput.value;
            const amount = entryAmountInput.value;
            const memo = entryMemoInput.value;
            const type = document.querySelector('input[name="entry-type"]:checked')?.value;
            const rowIndex = document.getElementById('entry-row-index').value;
            
            if (!date || !item || !amount || !type) {
                showMessage('日付、項目、金額、収支区分は必須です。', true);
                return;
            }

            const payload = {
                action: isUpdating ? 'update' : 'add',
                rowIndex: isUpdating ? parseInt(rowIndex) : null,
                date: date,
                item: item,
                amount: parseInt(amount),
                type: type,
                memo: memo
            };

            await sendDataToSpreadsheet(payload);
        }
        form.addEventListener('submit', submitForm);
        updateButton.addEventListener('click', submitForm);

        // スプレッドシートへのデータ送信
        async function sendDataToSpreadsheet(payload) {
            try {
                const response = await fetch(SPREADSHEET_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('通信エラーが発生しました。');
                }

                const result = await response.json();
                if (result.status === 'success') {
                    showMessage(result.message);
                    clearForm();
                    fetchRecords(); // データを再取得して更新
                } else {
                    showMessage(result.message, true);
                }
            } catch (error) {
                console.error('Error sending data:', error);
                showMessage('データの送信中にエラーが発生しました。', true);
            }
        }

        // 年度別集計の更新
        function updateSummary(data = allRecords) {
            const now = new Date();
            const currentFiscalYear = getFiscalYear(now).western;
            
            const currentYearRecords = data.filter(record => {
                const recordDate = new Date(record.date);
                return getFiscalYear(recordDate).western === currentFiscalYear;
            });
            
            let totalIncome = 0;
            let totalExpense = 0;

            currentYearRecords.forEach(record => {
                if (record.type === '収入') {
                    totalIncome += record.amount;
                } else if (record.type === '支出') {
                    totalExpense += record.amount;
                }
            });

            const balance = totalIncome - totalExpense;

            const fiscalYearText = getFiscalYear(now).japanese;
            document.getElementById('summary-container').previousElementSibling.innerHTML = `年度別集計 (${fiscalYearText}年度)`;
            document.getElementById('total-income').textContent = `¥${totalIncome.toLocaleString()}`;
            document.getElementById('total-expense').textContent = `¥${totalExpense.toLocaleString()}`;
            document.getElementById('balance').textContent = `¥${balance.toLocaleString()}`;
        }

        // 一括操作ボタンの表示切り替え
        function updateBulkButtonsVisibility() {
            if (selectedRecords.size > 0) {
                bulkDeleteButton.classList.remove('hidden');
                bulkSummaryButton.classList.remove('hidden');
            } else {
                bulkDeleteButton.classList.add('hidden');
                bulkSummaryButton.classList.add('hidden');
                bulkSummaryResults.classList.add('hidden');
            }
            selectAllCheckbox.checked = selectedRecords.size === filteredRecords.length && filteredRecords.length > 0;
        }

        // テーブル行の選択状態を更新
        function updateTableRowsSelection() {
            recordsTableBody.querySelectorAll('.record-checkbox').forEach(checkbox => {
                const rowIndex = parseInt(checkbox.dataset.rowIndex);
                checkbox.checked = selectedRecords.has(rowIndex);
                const row = checkbox.closest('tr');
                if (selectedRecords.has(rowIndex)) {
                    row.classList.add('table-row-selected');
                } else {
                    row.classList.remove('table-row-selected');
                }
            });
        }
        
        // 全選択チェックボックスのイベントリスナー
        selectAllCheckbox.addEventListener('change', (e) => {
            recordsTableBody.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
                const rowIndex = parseInt(checkbox.dataset.rowIndex);
                if (e.target.checked) {
                    selectedRecords.add(rowIndex);
                } else {
                    selectedRecords.delete(rowIndex);
                }
            });
            updateBulkButtonsVisibility();
            updateTableRowsSelection();
        });

        // 選択項目の削除
        bulkDeleteButton.addEventListener('click', async () => {
            if (confirm('選択した記録を削除しますか？')) {
                const payload = {
                    action: 'delete',
                    rowIndexes: [...selectedRecords]
                };
                await sendDataToSpreadsheet(payload);
                selectedRecords.clear();
            }
        });

        // 選択項目の集計
        bulkSummaryButton.addEventListener('click', () => {
            const selectedData = allRecords.filter(record => selectedRecords.has(record.rowIndex));
            const totalIncome = selectedData.filter(r => r.type === '収入').reduce((sum, r) => sum + r.amount, 0);
            const totalExpense = selectedData.filter(r => r.type === '支出').reduce((sum, r) => sum + r.amount, 0);
            const balance = totalIncome - totalExpense;

            document.getElementById('bulk-income').textContent = `収入合計: ¥${totalIncome.toLocaleString()}`;
            document.getElementById('bulk-expense').textContent = `支出合計: ¥${totalExpense.toLocaleString()}`;
            document.getElementById('bulk-balance').textContent = `残高: ¥${balance.toLocaleString()}`;
            bulkSummaryResults.classList.remove('hidden');
        });

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            // 初期表示は支出のプリセット
            renderPresets('expense');
            document.querySelector('input[name="entry-type"][value="支出"]').checked = true;

            // 今日の日付をセット
            const today = new Date().toISOString().split('T')[0];
            entryDateInput.value = today;

            fetchRecords();
        });
    </script>
</body>
</html>
